{% load static %}
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>AI Insights</title>
<style>
body { background:#0f1419; color:#f1f5f9; font-family:Arial; margin:0; }
.layout { display:flex; }
.sidebar { width:250px; background:#1a1f2e; height:100vh; padding:20px; }
.sidebar a { display:block; padding:10px; color:#cbd5e1; text-decoration:none; margin-bottom:5px; }
.sidebar a.active { background:#242d3d; color:#3b82f6; }
.main { flex:1; padding:30px; }
.card { background:#1a1f2e; padding:20px; border-radius:8px; margin-bottom:20px; }
.badge { padding:5px 10px; border-radius:20px; font-size:13px; }
.badge-low { background:#10b981; }
.badge-medium { background:#f59e0b; }
.badge-high { background:#ef4444; }
</style>
</head>

<body>
<div class="layout">

<div class="sidebar">
    <h3>Make-Up Classes</h3>
    <a href="{% url 'dashboard' %}">Dashboard</a>
    <a href="{% url 'faculty' %}">Faculty Control</a>
    <a href="{% url 'student' %}">Student Portal</a>
    <a href="{% url 'ai' %}" class="active">AI Insights</a>
</div>

<div class="main">

<h1>AI Attendance Analytics</h1>

<div class="card">
    <h3>Attendance Trend (Monthly)</h3>
    <canvas id="trendChart" width="600" height="300"></canvas>
</div>

<div class="card">
    <h3>Predicted Risk Level</h3>
    <p>
        Current Risk:
        <span id="riskBadge" class="badge"></span>
    </p>
    <p>Estimated Capacity Usage: <span id="capacityValue"></span>%</p>
</div>

</div>
</div>

<script>

// ===============================
// LOAD AI ANALYTICS (DB DRIVEN)
// ===============================
async function loadAIAnalytics() {

    try {
        const response = await fetch("/api/ai/analytics/");
        const data = await response.json();
        const trend = data.trend;

        if (!trend || trend.length === 0) return;

        // ==========================
        // DRAW SIMPLE TREND CHART
        // ==========================
        const canvas = document.getElementById("trendChart");
        const ctx = canvas.getContext("2d");

        const width = canvas.width;
        const height = canvas.height;

        ctx.clearRect(0, 0, width, height);

        const maxAttendance = Math.max(...trend.map(t => t.attendance));
        const padding = 40;
        const stepX = (width - padding * 2) / (trend.length - 1);

        ctx.strokeStyle = "#3b82f6";
        ctx.lineWidth = 3;
        ctx.beginPath();

        trend.forEach((point, index) => {
            const x = padding + index * stepX;
            const y = height - padding - (point.attendance / maxAttendance) * (height - padding * 2);

            if (index === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);

            ctx.fillStyle = "#3b82f6";
            ctx.beginPath();
            ctx.arc(x, y, 4, 0, Math.PI * 2);
            ctx.fill();
        });

        ctx.stroke();

        // ==========================
        // COMPUTE RISK LEVEL
        // ==========================

        const latest = trend[trend.length - 1].attendance;
        const avg = trend.reduce((a,b) => a + b.attendance, 0) / trend.length;

        let risk = "Low";
        let capacity = Math.round((latest / (avg || 1)) * 100);

        if (capacity > 120) risk = "High";
        else if (capacity > 90) risk = "Medium";

        const badge = document.getElementById("riskBadge");
        badge.innerText = risk;

        badge.className = "badge " +
            (risk === "Low" ? "badge-low" :
             risk === "Medium" ? "badge-medium" :
             "badge-high");

        document.getElementById("capacityValue").innerText = capacity;

    } catch (error) {
        console.error("AI Analytics Error:", error);
    }
}

document.addEventListener("DOMContentLoaded", loadAIAnalytics);

</script>

</body>
</html>